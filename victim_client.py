"""
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓█▒▒▒▒▒███████▒▒▒▒▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓████▒▒▒█   █▓██▒       ░█▓▒▒▒▓█  ░░░▓▒▒▒▓███▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█▓▓▒▒▓█▒▒▓█░   █▓▒█   ██░   ░░░░░   ▓█▒▓█      █▓▒▓▓   ▓█░▒███▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█     ▒██▒▓█░   ▒█▒█   ██░   ▓████▒▒▒██▒▓▒      █▓▒▓█   ▓█▒█░  ▒█▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
▒▒▒▒▒▒▓██▓▒▒▒▒▒▒▓█      ▓██▓█▒   ░███   ██░   █████████▓██        ▓▓▓█    ▒██░  ▒█▒▓██▒▓███▓▒▒▒▒▒▒▒▒
▒▒▒▒█▓   ███▒▒▒▒█░       ▒█▓█▒     ▒█   ██░   █████████▓██   ██   ▓▓▓█     ▒█░  ▒██░        ░█▓░▒▒▒▒
▒▒▒▒█░   ███▒▒▒▒█   ▒█▒  ▒███▒      ▒   ██░   ██▒     ▓█▒    ██   ▓██▓     ░█░  ▒██    ░▒░    █▓▒▒▒▒
░▒▒▒█░   ███▒▒▒▒█   ▒█▓   ░██▒   ░      ▓█▓░░░███▒░░░░██▒  ░░██░ ░▓███          ▒██   ░████▒░░█▓▒▒▒▒
▒▒▒▒█░   ███▒▒▒▒█   ▒██░░░▒██▓░░░█▒░░░░░▒█▒░░░█████░░░██▓░░░░░░░░░░██▓░░░░░     ▒█▓   ░████████▒▒▒▒▒
▒▒▒▒█░   ███▒▒▒██ ░░░░  ░░░▓██░░░██▓░░░░▒█▒░░░████▓░░░██▒░░░░░░░░░░██░░░▒█░░░░░░▒█▒   ▒███▒░▒▒▒▒▒▒▒▒
░░░▒█░ ░▒███▒░░█▒░░░░░░░░░░▓██░░░███▒░░░▒█▓▒░░░░░░░░░░█▓░░░▓████░░░██░░░▒██░░░░░▓█▒░░ ▓█▒  ▒███▒▒░▒▒
░░▒░█▒░░▒███▒░░█▒░░░▒▓▓▓▒░░▒██░░▒██▓█▓▒▒▒███▓▒▒▒▒▒▒▒▒▒██▒░▓█████▒░░██░░░▒███▒░░░▓█░░░░██▒░░░░▒█▒▒▒░░
▒░░░█▒░░▒███▒▓██▒░░▓█████░░░▓█▓▓███▒▒███████████████████████▒░▒██▓▓██▒░░▓████░░░▓█▒░░░████▒░░▓█▒▒░░▒
▒░░▒█▒░░▒████▓░█▒░░▓██▒▓███████████░░░▒▒▒▒▒█▓▒▒▒▒▓▓▓██▓▒▒▒░░░░▒███████████▒██▒░░██▒░░▒████▒░░▓█▒░░▒░
░░░░█▒░░░░░░░░░██████▓▒░░▒████▓▓▓█▓▒░░░░▓▓░ ▒▓▓▓▓▓▓▓▓░░░▓▓░░░░▒▒█▓▓▓██▓█▒░░████████▒░░░░▒▓░░░▓█▒░░░░
░░░░█▒░░░░░░▒███████▓▒▒▒█▓   ░   ░▒▓█▒▒▒█▒▒██▒░░░░░░░█▓░██▒▒▒█▓     ░   ▓▓▒▒▒▒███████▒░░░░░░░▓█▒░░░▒
░░░░█▓▒▒▓███████▒▒░░▒█▓░░    ▒▓▓████▒░░░░░░░▓██░░░░██░░░░░░░░█████▓▒░    ░░▓▓░░░░▒▒███████▒▒███▒░░░▒
░░░░▓██████▓▓▒░░░░░██    ░▓▓▓█████▓░░░░░░▒▒▓██▓░░░░▓██▒░░░░░░░▒█████▓▓▓▓░  ░▓█▓░░░░░░▒███████▓░░░░░░
░░░░░▒▒█▓▒░░░░░░░░░██▓▒▒▓▓████░  ░████████████▓▓▓█▓▓███████████░   █████▓▓████▓░░░░░░░░░░▒▒▒▒░░░░░░░
░░░░░░░░░░░░▒▒▒▒░░▓█▒░▒████████▓▓   ██▒░░░███▒▓▒▒▒▒▒▒▒██▒░░▒██  ▓▓▓████████▒ ██▓░░░▒▒▒▒░░░░░░░░░░░░░
▒░░░░░░░░░▓▓▒▒▒███▒  ▒███████████▓▓▓██▒░░░░▒▓▓▓▓▓▓▓▓▓▓▓▒░░░▒▓█▓▓████████████░  ▒███▓▒▒▒▓▒░░░░░░░░░░░
░░░░░░░░▒█  ▒▓██▒  ▒████▓▒░░▒▓▓▓▓███▒░░░█░ ▓▒░░░░░░░░░███▓░░░▒███▓▓▓▓▒▒▒▓█████▓   ██▓▓░ █▒░░░░░░░░░▒
░░░░░░▒█▒ ░████  ▓██▓░▓█████████████░░░░▒▒█▒░░░░░░░░░░░▒▒▒░░░▒██████████████░▓██▓░ ░█▓█▒ ░█▒░░░░░░░░
░░░░░▒▓▒  ██▒████████▓░█████████████░░░░░░░░░░▓████▓░░░░░░░░░▒█▓░▒████████▓░▓████████▒▓█▓ ░▓▒░░░░░░░
░░░░▒█░ ▒█▒░░░░▒▒█▓▒█▓░██▓░▒██████████░░░░░▒▓▓▓▒▓▓████▓▒░░░░░██░█▒████████▓░▓█▒▒██▒▒░░░▒█▓  █▓░░░░░░
░░░░▒█  ██▒▒░░░▒▓ ░██▓░██▒▒▒░█████████▒░░░█▓░░░█████████▓░░░▒█████████████▓░▓█▓▒ ▓█░░░▒▒▒█░ █▓░░░░░░
░░░░▒▓█░░▒▓██▒█▒ ▒██▒░░███████████████▒░▓█▓▒▒█████████████▒░▒██████████████▓░░██▒  ▓▒▒██▓ ▒█▓▒░░░░░░
░░░░░░▒██▒ ▒█▓ ░▓█▓░░░░███████████████░░█▓░▒▒████▒   ▒█████░░██████████████▓░░░▓██░ ░▒▓░░██▓░░░░░░░░
░░░░░░░░▒███▓▓▓██░░░░░░░███████████████████░        ▒▒████████▓░██████████▓░░░░░░██▓▓▓███▒░░░░░░░░░░
░░░░░░░░░░▒▓███▒░░░░░░░░█████████████████░ ███▓█████░ ▓█░░▒▓██▓███████████▓░░░░░░░▒███▓▒░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░▓███████████████░ █▓░░░░░██  ▓███▓██████████████▓░░░░░░░░░░░░░░░░░▒░░░░░░░░
░░░░░░░░░░░░░░░░░░██░▒▒▒░▒████████████████▒ ░▒ ░▒  ▒█████████████████████▒░░░░░░░░░░░░░░░███▒░░░░░░░
░░░░░░░░░░░░░░░░▒▓   ▓█▓░░▒██████████████▒ ░▓▒▒▒▒▒▒  ▓█████████████████▒░░░░██▒▓▒░░░░░░░░▒▓▒░░░░░░░░
░░░░░▒▓ ░█▒░░░░░░█████▒░░░░░▓████████████░██████████▒▒████████████████▒░░░▓█░░▒▓▒░░░░░▒▒░░░░░░░░░░░░
░░░░░▒███▒░░░░░░░░░░░░░░░░░░░▒███████████████████████▓██████████████▓░░░░░░▒██░░░░░░░▒█░▒▓█▓░░░░░░░░
░░░░░░░▒░░░░░░░░░░░░░░░░░▒▓░░░▒███████▒ ▓██▒░░░░░░░▒▓███▒░▒████████▓▒░░░░░░░░░░░░░░░░░██▓▓██▓░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░▓▒░██░░░░░░████░    ▒██████████▓░   ░███████▒░░░░░░░░░░░░░░░▒░░░░▒▓▓▓▒░░░░░░░░
░░░░░░░░░░▒░▒▒░░░░░░░░████░░░░░░░░▓██▒       ▒███▒        ▒█████░░░░░░░░░░░░░░░░░▒█▒░░░░░░░░░░░░░░░░
░░░░░░░░░░░▓▓░░░░░░░░░░░░░░░░░░░░░▓████▓▒░    ░█▓    ░▒▒▓▓██████░░░░░█▒▒█▒░░░░░░░░░░░░░░░▒▒░░░░░░░░░
░░░░▒▓█▒░░░░░░░░░░▒░▓▓░░░░░░░░░░░░▒▓█████████▓▓██▓▓▓▓▓▓▓███████▒░░░░░██▓▓█░░░░░░░░░░░░▒█░ ░███▓░░░░░
░░▒▓▒  █▓▒░░░░░░░░▓▒███▒░░░░░░░░░░░░██████          ▒▓████████▒░░░░░░░▓█▒░░░░░░░░░░░░░▒██    ██▓░░░░
▓█░ ▓█▓░ ▒█▒░░░░░░░▓███▓░░░░░░░░░░░░▒███▒             ▓██████░░░░░░░░░░░░░▒░▓█▒░░░░░░░░▒████▓█▓░░░░░
█▓ █▒░░▓▒ ░▓▒░░░░░░░░░░░░░░░░░░░░░░░▒████▒    ░▒    ░▒███████░░░░░░░░░░░██▒▒██▓░░░░░▒▓░░░▒▓▓▓▒░░░░░░
█▓ ▒█▒░░██ ░█▒░░░░░░░░░░░░░░░░░░░░░░███████░  ░▒░ ▒▓▓█████████░░░░░░░░░░░█████▓░░░░░░░░░░░░░░░░░░░░░
▒▓▒ ▒█▒░▒█ ▒█▒░░░░░░░░░░░░░░░░░░░▒███████████▓▓▓▓▓▓████████████▓░░░░░░░░░░▒▒▒░░░░░░░░░░░░░░░░░░░░░░░
░▒██░░▓█▓░▒█▓▒░░░░░░░░░░░░░░░░░░▒█▒░▓████████████████████▓▓██████▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░██  ▒█▒░░░░░░░░░░░░░░░░░░░▓██░████████████████████████████████▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░░▓▓▓▓▒░░░░░░░░░░░░░░░░░░░░▓███████████████▓▓▓▓▓▓███████████████▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓████████████▒░░░░░░░░░▒██████████████▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░███████████▒░░░░░░░░░░░░░░████████████▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓▓▒▒▓█▓▓▓████▒░░░░░░░░░░░░░░█████▒▓██▒▒███▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▓█▒▒░▒█░░░▒▓████▒▒▒▒▒▒▒▒▒▒▒▒▒▒███▓▓░░░▓█▒▒█▓█▓▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▓███████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓████████████████▓▓▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░

╔═══════════════════════════════════════════════════════════════════════════════╗
║***                       SafeGuardian AI Victim Client                     ***║
╚═══════════════════════════════════════════════════════════════════════════════╝
File:    victim_client.py
Version: 1.0.0
Author:  Advanced Rescue Operations Team
Updated: 2023-07-15

This script implements a Streamlit-based client interface for disaster victims
to interact with a rescue bot. It leverages Google's Gemini AI for natural 
language processing and integrates various tools for data collection, 
geolocation, and rescue operations management. Victims can send real-time 
information to rescue teams through text or audio input, and the bot responds 
to user queries. It is designed to handle disaster scenarios by collecting, 
validating, and transmitting critical data to intervention teams using NLP 
and rescue APIs.
"""

#==============================================================================
#                               IMPORTS
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Imports                                                         ║
║  How it works: This section handles the inclusion of external libraries    ║
║  and internal modules required for configuration, logging, JSON processing,║
║  geolocation, audio processing, and NLP integration with Google's Gemini   ║
║  AI. It sets up the foundation needed for interacting with the rescue bot. ║
║  CAN be Changed: You may add or remove modules depending on functionality  ║
║  (e.g., adding new APIs, additional AI tools).                             ║
║  MUST NOT be Changed: Essential modules such as Streamlit and Google AI    ║
║  integrations must remain to ensure core functionalities operate.          ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""

import os
import json
import logging
import datetime
import streamlit as st
from typing import Dict, Any, List
import google.generativeai as genai
from audiorecorder import audiorecorder

# Internal Modules
from victim_tools.llm_utils import GeminiConfig, schema
from victim_tools.geolocation_data import geolocation_data
from victim_tools.rescue_data import get_rescue_data
from victim_tools.vital_data import update_victim_json
from victim_tools.json_cleaner import upload_victim_info
from victim_tools.audio_processing import process_audio, play_audio
from victim_tools.function_calling import provide_user_location
from victim_tools.state_manager import StateManager
from rescue_tools.fetch_vital_data import json_template
from rescue_api import RescueAPI

#==============================================================================
#                           LOGGING SETUP
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Logging Setup                                                   ║
║  How it works: Sets up basic logging for the script to capture important   ║
║  runtime information such as errors, warnings, and general info. This is   ║
║  critical for monitoring the behavior of the rescue bot and debugging.     ║
║  CAN be Changed: Log level can be set to DEBUG for more detailed logs, or  ║
║  redirected to log files for longer-term storage (`logging.FileHandler`).  ║
║  MUST NOT be Changed: Basic logging should remain in place to ensure       ║
║  critical events are captured during operation.                            ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

#==============================================================================
#                           CONFIGURATION
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Configuration                                                   ║
║  How it works: Configures the environment, including API keys, the model   ║
║  path for Google’s Gemini AI, and the expected response format for API     ║
║  calls. This is necessary to securely access AI services and manage bot    ║
║  responses in a predictable format.                                         ║
║  CAN be Changed: The AI model path (`model_path`) and response format      ║
║  (`response_type`) can be adjusted depending on the model or data needs.   ║
║  MUST NOT be Changed: Environment variables (`os.getenv()`) must be used   ║
║  for secure API access, and should not be hardcoded in the script.         ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
gemini_api = os.getenv("gemini_api")  # Google Gemini API key is stored securely
os.environ['GOOGLE_API_KEY'] = gemini_api
model_path = 'models/gemini-1.5-flash'  # Defines the path to the AI model version
response_type = 'application/json'  # The API will respond in JSON format
config = GeminiConfig(gemini_api, model_path, response_type)

def get_location_from_wifi() -> str:
    """
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  Function: get_location_from_wifi                                         ║
    ║  How it works: This function calls geolocation services using WiFi        ║
    ║  signals to estimate the user's current location. If successful, it       ║
    ║  returns the location; otherwise, it catches exceptions and returns an    ║
    ║  error message.                                                           ║
    ║  CAN be Changed: The API key for geolocation can be changed or updated.   ║
    ║  MUST NOT be Changed: Ensure proper error handling is in place to         ║
    ║  prevent failures during real-time operations.                            ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
    """
    try:
        return geolocation_data(os.getenv('geolocator_api'))
    except Exception as e:
        return f"Error occurred: {e}"

#==============================================================================
#                           STREAMLIT SETUP
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Streamlit Setup                                                 ║
║  How it works: Configures the user interface, setting page titles, layout, ║
║  and page icons. Additionally, theme and visual aspects of the UI can be   ║
║  adjusted, allowing flexibility in interface design for different contexts.║
║  CAN be Changed: You can modify `page_title`, `layout`, and `theme` to     ║
║  match branding or user preferences.                                       ║
║  MUST NOT be Changed: Streamlit’s basic page configuration should remain   ║
║  to ensure the UI initializes correctly.                                   ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
st.set_page_config(page_title="Natural Hazard Rescue Bot💬", layout="wide", page_icon="🚑")
st._config.set_option("theme.base", "dark")
st._config.set_option("theme.backgroundColor", "black")
st._config.set_option("runner.fastReruns", "false")

#==============================================================================
#                           STATE INITIALIZATION
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: State Initialization                                            ║
║  How it works: Initializes necessary states to track session data such as  ║
║  victim information, templates, and the unique victim identifier (ID). This║
║  ensures continuity between user interactions and preserves data across    ║
║  sessions using Streamlit’s session state.                                 ║
║  CAN be Changed: New states can be added to track additional information,  ║
║  such as user preferences or rescue status.                                ║
║  MUST NOT be Changed: Keys like `json_template`, `victim_info`, and        ║
║  `victim_number` are essential and should not be modified or removed.      ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
if "json_template" not in st.session_state:
    st.session_state['json_template'] = json_template

if "victim_info" not in st.session_state:
    st.session_state.victim_info = json_template

if "victim_number" not in st.session_state:
    rescue = RescueAPI()
    st.session_state['victim_number'] = rescue.post_victim(st.session_state['victim_info'])

#==============================================================================
#                           FUNCTION DEFINITIONS
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Function Definitions                                            ║
║  How it works: This section defines the core functions available for the   ║
║  bot’s operations. These include fetching rescue data, geolocation, and    ║
║  processing victim information. Functions are called dynamically based on  ║
║  AI interactions or user inputs.                                           ║
║  CAN be Changed: You can add new functions to enhance bot capabilities or  ║
║  extend to new tasks (e.g., new APIs).                                     ║
║  MUST NOT be Changed: The core function names must be consistent across    ║
║  the code (e.g., `get_rescue_data`, `get_location`).                       ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
function_calling = {
    'get_rescue_data': get_rescue_data,
    'get_location': provide_user_location,
}

#==============================================================================
#                           GEMINI AI SETUP
#==============================================================================
"""
╔═══════════════════════════════════════════════════════════════════════════╗
║  Function: Gemini AI Setup                                                 ║
║  How it works: Initializes the Gemini AI model using the configuration     ║
║  and tools defined above. It establishes the connection for natural        ║
║  language interaction between victims and the rescue bot. This also        ║
║  handles automatic function calling (e.g., fetching rescue data).          ║
║  CAN be Changed: You can modify the model or adjust safety settings based  ║
║  on edge cases and false positives.                                        ║
║  MUST NOT be Changed: Ensure that the `tools` parameter correctly passes   ║
║  callable functions to the AI for interaction.                             ║
╚═══════════════════════════════════════════════════════════════════════════╝
"""
model = genai.GenerativeModel(
    config.model_path,
    tools=list(function_calling.values()),
    system_instruction="Help victims and collect data for intervention teams.",
    safety_settings=config.safety,
)
chat = model.start_chat(enable_automatic_function_calling=True)

#==============================================================================
#                           MAIN APPLICATION
#==============================================================================
def main():
    """
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║  Function: main                                                           ║
    ║  How it works: This is the entry point for the Streamlit application. It  ║
    ║  sets up the user interface, defines columns for chat interaction and     ║
    ║  victim data display, and manages communication between the AI model and  ║
    ║  the victim.                                                              ║
    ║  CAN be Changed: You can alter the layout (columns, containers, etc.) to  ║
    ║  customize the interaction flow or add additional information displays.   ║
    ║  MUST NOT be Changed: The core functionality (displaying victim info and  ║
    ║  chat interface) should remain.                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
    """
    st.title("💬 Natural Hazard Rescue App ⚠️🚑")
    st.write("This bot is designed to help victims of natural disasters by providing support and information. It can also collect valuable data for intervention teams.")
    
    # Define the layout: left side for chat, right side for victim information.
    left, middle, right = st.columns([.5, .1, .4])
    
    with left:
        chat_container(height=820)
    with right:
        display_victim_info()

main()
